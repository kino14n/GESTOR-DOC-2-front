<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor de Documentos - Kino Company SAS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="css/main.css" rel="stylesheet" />
  <link href="css/modals.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center p-6">

  <!-- Modal de acceso (puedes comentar/descomentar para pruebas) -->
  <!-- <div id="loginOverlay" class="overlay"></div> -->

  <!-- Toast y modales -->
  <div id="toast-container"></div>
  <div id="modals"></div>

  <div id="mainContent" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg">
    <div class="bg-white border-b">
      <h1 class="text-2xl font-bold text-center py-4">Gestor de Documentos V1</h1>
    </div>

    <nav class="border-b bg-white shadow-sm">
      <ul id="tabs" class="flex">
        <li class="tab flex-1 text-center cursor-pointer px-6 py-4 active" data-tab="tab-search">Buscar</li>
        <li class="tab flex-1 text-center cursor-pointer px-6 py-4" data-tab="tab-upload">Subir</li>
        <li class="tab flex-1 text-center cursor-pointer px-6 py-4" data-tab="tab-list">Consultar</li>
        <li class="tab flex-1 text-center cursor-pointer px-6 py-4" data-tab="tab-code">Buscar por Código</li>
      </ul>
    </nav>

    <div class="p-6 space-y-6">
      <!-- TAB BUSQUEDA VORAZ -->
      <div id="tab-search" class="tab-content">
        <h2 class="text-xl font-semibold mb-4">Búsqueda Voraz (Inteligente)</h2>
        <textarea id="searchInput" rows="5" class="w-full border rounded px-3 py-2 text-lg mb-4" placeholder="Pega aquí uno o varios códigos, nombres o bloques de texto…"></textarea>
        <div class="flex gap-4 mb-4">
          <button onclick="doVorazSearch()" class="btn btn--primary btn--flex1 text-lg">Buscar</button>
          <button onclick="clearSearch()" class="btn btn--secondary btn--flex1 text-lg">Limpiar</button>
        </div>
        <div id="search-alert" class="text-red-600 font-medium text-lg mb-4"></div>
        <div id="results-search" class="space-y-4"></div>
      </div>

      <!-- TAB SUBIR -->
      <div id="tab-upload" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Subir / Editar Documento</h2>
        <form id="form-upload" enctype="multipart/form-data" class="space-y-4">
          <input id="docId" type="hidden" name="id" />
          <div>
            <label class="block mb-1 text-lg">Nombre</label>
            <input id="name" name="name" type="text" required class="w-full border rounded px-3 py-2 text-lg" />
          </div>
          <div>
            <label class="block mb-1 text-lg">Fecha</label>
            <input id="date" name="date" type="date" required class="w-full border rounded px-3 py-2 text-lg" />
          </div>
          <div>
            <label class="block mb-1 text-lg">PDF</label>
            <input id="file" name="file" type="file" accept="application/pdf" class="w-full text-lg" />
            <p id="uploadWarning" class="mt-1 text-red-600 text-sm hidden">
              El archivo excede los 10 MB. Por favor, sube uno menor.
            </p>
          </div>
          <div>
            <label class="block mb-1 text-lg">Códigos</label>
            <textarea id="codes" name="codigos" rows="4" class="w-full border rounded px-3 py-2 text-lg"></textarea>
          </div>
          <button type="submit" class="btn btn--primary btn--full text-lg">Guardar</button>
        </form>
      </div>

      <!-- TAB CONSULTAR -->
      <div id="tab-list" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Consultar Documentos</h2>
        <div class="flex gap-4 mb-4">
          <input
            id="consultFilterInput"
            type="text"
            class="flex-1 border rounded px-3 py-2 text-lg"
            placeholder="Filtrar por nombre o código"
            oninput="doConsultFilter()"
          />
          <button onclick="clearConsultFilter()" class="btn btn--secondary text-lg">Limpiar</button>
          <button onclick="downloadCsv()" class="btn btn--primary text-lg">Descargar CSV</button>
        </div>
        <div id="results-list" class="space-y-4"></div>
      </div>

      <!-- TAB BUSCAR POR CÓDIGO -->
      <div id="tab-code" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Buscar por Código</h2>
        <div class="relative mb-4">
          <input
            id="codeInput"
            type="text"
            class="w-full border rounded px-3 py-2 text-lg"
            placeholder="Escribe un código"
            autocomplete="off"
          />
          <div
            id="suggestions"
            class="absolute top-full left-0 right-0 bg-white border rounded-b px-2 shadow max-h-48 overflow-auto hidden z-20"
          ></div>
        </div>
        <button onclick="doCodeSearch()" class="btn btn--primary btn--full mb-4 text-lg">Buscar por Código</button>
        <div id="results-code" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- Toasts y modales -->
  <div id="toast-container"></div>
  <div id="modals"></div>

  <!-- Scripts -->
  <script src="js/main.js" type="module"></script>
  <script src="js/api.js" type="module"></script>
  <script src="js/auth.js" type="module"></script>
  <script src="js/modals.js" type="module"></script>
  <script src="js/autocomplete.js" type="module"></script>
  <script src="js/toasts.js" type="module"></script>
  <script src="js/consulta.js" type="module"></script>
  <script src="js/upload.js" type="module"></script>

  <script type="module">
    import { cargarConsulta, clearConsultFilter, doConsultFilter, downloadCsv } from './js/consulta.js';
    import { initAutocompleteCodigo } from './js/autocomplete.js';

    // Hacer globales las funciones para los onClick del HTML
    window.doVorazSearch = async function () {
      const text = document.getElementById('searchInput').value.trim();
      const alertDiv = document.getElementById('search-alert');
      const resultsDiv = document.getElementById('results-search');
      alertDiv.textContent = '';
      resultsDiv.innerHTML = '';
      if(text.length < 1){
        alertDiv.textContent = 'Pega o escribe uno o varios códigos para buscar.';
        return;
      }
      // Endpoint voraz
      try {
        const res = await fetch('https://gestor-doc-backend-production.up.railway.app/api/documentos/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ texto: text })
        });
        const data = await res.json();
        if(data.length === 0){
          resultsDiv.innerHTML = '<p>No se encontraron resultados.</p>';
          return;
        }
        resultsDiv.innerHTML = data.map(doc => `
          <div class="border p-4 rounded shadow">
            <h3 class="font-semibold">${doc.name}</h3>
            <p><b>Fecha:</b> ${doc.date || ''}</p>
            <p><b>Códigos:</b> ${doc.codigos_extraidos || ''}</p>
            <p><b>PDF:</b> ${doc.path ? `<a href="uploads/${doc.path}" target="_blank" class="text-blue-600 underline">${doc.path}</a>` : ''}</p>
          </div>
        `).join('');
      } catch(e) {
        alertDiv.textContent = 'Error al buscar. Intente de nuevo.';
      }
    }

    window.clearSearch = function () {
      document.getElementById('searchInput').value = '';
      document.getElementById('search-alert').textContent = '';
      document.getElementById('results-search').innerHTML = '';
    }
    window.doConsultFilter = doConsultFilter;
    window.clearConsultFilter = clearConsultFilter;
    window.downloadCsv = downloadCsv;
    window.doCodeSearch = async function () {
      const input = document.getElementById('codeInput');
      const code = input.value.trim();
      const resultsDiv = document.getElementById('results-code');
      resultsDiv.innerHTML = '';
      if(code.length < 1){
        resultsDiv.innerHTML = '<p>Escribe un código para buscar.</p>';
        return;
      }
      try {
        const res = await fetch('https://gestor-doc-backend-production.up.railway.app/api/documentos/search_by_code', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ codigo: code })
        });
        const data = await res.json();
        if(data.length === 0){
          resultsDiv.innerHTML = '<p>No se encontró ningún documento con ese código.</p>';
          return;
        }
        resultsDiv.innerHTML = data.map(doc => `
          <div class="border p-4 rounded shadow">
            <h3 class="font-semibold">${doc.name}</h3>
            <p><b>Fecha:</b> ${doc.date || ''}</p>
            <p><b>Códigos:</b> ${doc.codigos_extraidos || ''}</p>
            <p><b>PDF:</b> ${doc.path ? `<a href="uploads/${doc.path}" target="_blank" class="text-blue-600 underline">${doc.path}</a>` : ''}</p>
          </div>
        `).join('');
      } catch(e) {
        resultsDiv.innerHTML = '<p>Error en la búsqueda por código.</p>';
      }
    }

    // Activa autocomplete en pestaña código
    window.onload = () => {
      initAutocompleteCodigo();
      cargarConsulta();
    };
  </script>
</body>
</html>
